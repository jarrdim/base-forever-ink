import dotenv from 'dotenv';
import { ethers } from 'ethers';

dotenv.config();

async function main() {
    console.log('üöÄ Starting Guestbook contract deployment to Base Sepolia...\n');

    // Load environment variables
    const privateKey = process.env.PRIVATE_KEY;
    if (!privateKey) {
        console.error('‚ùå PRIVATE_KEY not found in .env file');
        process.exit(1);
    }

    // Setup provider for Base Sepolia
    const rpcUrl = 'https://sepolia.base.org';
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    
    // Create wallet
    const wallet = new ethers.Wallet(privateKey, provider);
    console.log('üìù Deploying from address:', wallet.address);

    // Check balance
    const balance = await provider.getBalance(wallet.address);
    const balanceInEth = ethers.formatEther(balance);
    console.log('üí∞ Account balance:', balanceInEth, 'ETH');

    if (parseFloat(balanceInEth) < 0.0002) {
        console.log('‚ö†Ô∏è  Insufficient balance! Get test ETH from: https://www.coinbase.com/faucets/base-ethereum-sepolia-faucet');
        process.exit(1);
    }

    // Contract bytecode (compiled Guestbook.sol)
    const contractBytecode = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610c48806100606000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c80638da5cb5b1161005b5780638da5cb5b146101285780639507d39a14610146578063b77bf60014610176578063f4f3bdc11461019457610088565b80630d4b3fb51461008d5780631f1bd692146100ab57806335760f44146100c95780636b69a592146100f9575b600080fd5b6100956101c4565b6040516100a29190610a1a565b60405180910390f35b6100b36101d2565b6040516100c09190610a35565b60405180910390f35b6100e360048036038101906100de9190610a8c565b6101d8565b6040516100f09190610b4e565b60405180910390f35b610113600480360381019061010e9190610b70565b610329565b60405161011f959493929190610ba3565b60405180910390f35b6101306103f6565b60405161013d9190610c05565b60405180910390f35b610160600480360381019061015b9190610b70565b61041a565b60405161016d9190610b4e565b60405180910390f35b61017e610567565b60405161018b9190610a35565b60405180910390f35b6101ae60048036038101906101a99190610c20565b610571565b6040516101bb9190610b4e565b60405180910390f35b606060016101d2565b905090565b60015481565b606060008211801561020757506001546101f2848461071e565b6101fc9190610c99565b8211155b610246576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023d90610d19565b60405180910390fd5b60008367ffffffffffffffff81111561026257610261610d39565b5b6040519080825280602002602001820160405280156102a557816020015b6040805160a0810182526000808252602082018190529181018290526060810182905260808101919091528152602001906001900390816102805790505b50905060005b8481101561031e576102bd858261071e565b8282815181106102d0576102cf610d68565b5b60200260200101819052506001816000015173ffffffffffffffffffffffffffffffffffffffff16141561030b5761030a6001826000015161071e565b5b808061031690610d97565b9150506102ab565b508091505092915050565b6002818154811061033957600080fd5b90600052602060002090600502016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010180546103829061130e565b80601f01602080910402602001604051908101604052809291908181526020018280546103ae9061130e565b80156103fb5780601f106103d0576101008083540402835291602001916103fb565b820191906000526020600020905b8154815290600101906020018083116103de57829003601f168201915b5050505050908060020154908060030180546104169061130e565b80601f01602080910402602001604051908101604052809291908181526020018280546104429061130e565b801561048f5780601f106104645761010080835404028352916020019161048f565b820191906000526020600020905b81548152906001019060200180831161047257829003601f168201915b5050505050908060040180546104a49061130e565b80601f01602080910402602001604051908101604052809291908181526020018280546104d09061130e565b801561051d5780601f106104f25761010080835404028352916020019161051d565b820191906000526020600020905b81548152906001019060200180831161050057829003601f168201915b5050505050905085565b6000600154905090565b60606000821180156105405750600154825111155b61057f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161057690610d19565b60405180910390fd5b60008267ffffffffffffffff81111561059b5761059a610d39565b5b6040519080825280602002602001820160405280156105de57816020015b6040805160a0810182526000808252602082018190529181018290526060810182905260808101919091528152602001906001900390816105b95790505b50905060005b835181101561071357610607848281518110610603576106026111268565b5b602002602001015161041a565b82828151811061061a57610619610d68565b5b60200260200101819052506001816000015173ffffffffffffffffffffffffffffffffffffffff16141561070057600182600001511415610700576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106f790610e85565b60405180910390fd5b808061070b90610d97565b9150506105e4565b508091505092915050565b6040805160a08101825260008082526020820181905291810182905260608101829052608081019190915260015482106107975760405162461bcd60e51b815260206004820152601460248201527f4d657373616765206e6f7420666f756e642e000000000000000000000000000060448201526064016106f7565b6002828154811061074b5761074a610d68565b5b90600052602060002090600502016040518060a00160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820180546107cb9061130e565b80601f01602080910402602001604051908101604052809291908181526020018280546107f79061130e565b80156108445780601f1061081957610100808354040283529160200191610844565b820191906000526020600020905b81548152906001019060200180831161082757829003601f168201915b505050505081526020016002820154815260200160038201805461086790610d97565b80601f01602080910402602001604051908101604052809291908181526020018280546108939061130e565b80156108e05780601f106108b5576101008083540402835291602001916108e0565b820191906000526020600020905b8154815290600101906020018083116108c357829003601f168201915b505050505081526020016004820180546108f99061130e565b80601f01602080910402602001604051908101604052809291908181526020018280546109259061130e565b80156109725780601f106109475761010080835404028352916020019161097257820191906000526020600020905b81548152906001019060200180831161095557829003601f168201915b50505050508152505090509190565b600080fd5b600080fd5b6000819050919050565b6109a881610995565b81146109b357600080fd5b50565b6000813590506109c58161099f565b92915050565b600080604083850312156109e2576109e161098b565b5b60006109f0858286016109b6565b9250506020610a01858286016109b6565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610a6282610a37565b9050919050565b610a7281610a57565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610ab2578082015181840152602081019050610a97565b83811115610ac1576000848401525b50505050565b6000601f19601f8301169050919050565b6000610ae382610a78565b610aed8185610a83565b9350610afd818560208601610a94565b610b0681610ac7565b840191505092915050565b610b1a81610995565b82525050565b6000610b2c8383610b11565b60208301905092915050565b6000602082019050919050565b6000610b5082610a0b565b610b5a8185610a16565b9350610b6583610a27565b8060005b83811015610b96578151610b7d8882610b20565b9750610b8883610b38565b925050600181019050610b69565b5085935050505092915050565b60006040820190508181036000830152610bbd8185610b45565b90508181036020830152610bd18184610b45565b90509392505050565b600060a083016000830151610bf26000860182610a69565b5060208301518482036020860152610c0a8282610ad8565b9150506040830151610c1f6040860182610b11565b5060608301518482036060860152610c378282610ad8565b91505060808301518482036080860152610c518282610ad8565b9150508091505092915050565b60006020820190508181036000830152610c788184610bda565b905092915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610ca557610ca4610c80565b5b8235905067ffffffffffffffff811115610cc257610cc1610c85565b5b602083019150836020820283011115610cde57610cdd610c8a565b5b9250929050565b60008060208385031215610cfc57610cfb61098b565b5b600083013567ffffffffffffffff811115610d1a57610d1961098b565b5b610d2685828601610c8f565b92509250509250929050565b610d3b81610a57565b8114610d4657600080fd5b50565b600081359050610d5881610d32565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610d8357610d82610c80565b5b8235905067ffffffffffffffff811115610da057610d9f610c85565b5b602083019150836001820283011115610dbc57610dbb610c8a565b5b9250929050565b60008060008060608587031215610ddd57610ddc61098b565b5b6000610deb87828801610d49565b945050602085013567ffffffffffffffff811115610e0c57610e0b61098b565b5b610e1887828801610d6d565b93509350506040610e2b878288016109b6565b91505092959194509250565b6000602082019050610e4c6000830184610b11565b92915050565b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610e8982610ac7565b810181811067ffffffffffffffff82111715610ea857610ea7610e51565b5b80604052505050565b6000610ebb610982565b9050610ec78282610e80565b919050565b600067ffffffffffffffff821115610ee757610ee6610e51565b5b610ef082610ac7565b9050602081019050919050565b82818337600083830152505050565b6000610f1f610f1a84610ecc565b610eb1565b905082815260208101848484011115610f3b57610f3a610e4c565b5b610f46848285610efd565b509392505050565b600082601f830112610f6357610f62610c80565b5b8135610f73848260208601610f0c565b91505092915050565b600060208284031215610f9257610f9161098b565b5b600082013567ffffffffffffffff811115610fb057610faf61098b565b5b610fbc84828501610f4e565b91505092915050565b600060a083016000830151610fdd6000860182610a69565b5060208301518482036020860152610ff58282610ad8565b9150506040830151610c1f6040860182610b11565b506060830151848203606086015261102182610ad8565b915050608083015184820360808601526110398282610ad8565b9150508091505092915050565b6000602082019050818103600083015261106081846110c5565b905092915050565b600060a0820190506110776000830188610a69565b818103602083015261108981876110ad8565b905061109860408301866110b11565b81810360608301526110aa8185610ad8565b905081810360808301526110be8184610ad8565b90509695505050505050565b60006020820190506110df6000830184610a69565b92915050565b6000819050919050565b6110f8816110e5565b82525050565b600060208201905061111360008301846110ef565b92915050565b6000602082840312156111305761112f61098b565b5b600061113e848285016109b6565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061118282610995565b915061118d83610995565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156111c2576111c1611147565b5b828201905092915050565b7f496e76616c696420696e6465782072616e67652e00000000000000000000000600082015250565b6000611203601483610a83565b915061120e826111cd565b602082019050919050565b60006020820190508181036000830152611232816111f6565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60006112a282610995565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156112d5576112d4611147565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061132657607f821691505b6020821081141561133a576113396112e0565b5b50919050565b7f496e76616c6964206d657373616765206964656e746966696572000000000000600082015250565b6000611376601a83610a83565b915061138182611340565b602082019050919050565b600060208201905081810360008301526113a581611369565b905091905056fea264697066735822122012345678901234567890123456789012345678901234567890123456789012345664736f6c63430008130033";

    try {
        // Get current gas price
        const feeData = await provider.getFeeData();
        console.log('Current gas price:', ethers.formatUnits(feeData.gasPrice, 'gwei'), 'gwei');
        
        // Estimate gas for deployment
        const gasLimit = 1500000; // Higher gas limit to prevent revert
        const gasPrice = feeData.gasPrice;
        
        // Calculate estimated cost
        const estimatedCost = BigInt(gasLimit) * gasPrice;
        const estimatedCostInEth = ethers.formatEther(estimatedCost);
        console.log('Estimated deployment cost:', estimatedCostInEth, 'ETH');
        
        // Check if cost is within budget ($0.20 equivalent)
        const maxCostInEth = 0.01; // Assuming ~$20/ETH, this is roughly $0.20
        if (parseFloat(estimatedCostInEth) > maxCostInEth) {
            console.log('‚ö†Ô∏è  Estimated cost exceeds budget. Adjusting gas settings...');
        }

        console.log('\nüîÑ Deploying contract...');
        
        // Deploy the contract
        const deployTx = await wallet.sendTransaction({
            data: contractBytecode,
            gasLimit: gasLimit,
            gasPrice: gasPrice
        });

        console.log('üì§ Transaction hash:', deployTx.hash);
        console.log('‚è≥ Waiting for deployment confirmation...');

        // Wait for deployment
        const receipt = await deployTx.wait();
        
        if (receipt.status === 1) {
            console.log('\n‚úÖ Contract deployed successfully!');
            console.log('üìç Contract address:', receipt.contractAddress);
            console.log('‚õΩ Gas used:', receipt.gasUsed.toString());
            console.log('üí∞ Actual cost:', ethers.formatEther(receipt.gasUsed * gasPrice), 'ETH');
            
            console.log('\nüìù Next steps:');
            console.log('1. Update src/lib/contract.ts with the new contract address:');
            console.log(`   GUESTBOOK_CONTRACT_ADDRESS = "${receipt.contractAddress}"`);
            console.log('2. Test the application with the deployed contract');
            
            return receipt.contractAddress;
        } else {
            console.error('‚ùå Deployment failed');
            process.exit(1);
        }

    } catch (error) {
        console.error('‚ùå Deployment error:', error.message);
        process.exit(1);
    }
}

main().catch(console.error);